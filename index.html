<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Generador de Campa침a</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            color: #333;
            margin: 0;
            overscroll-behavior: none;
        }

        h2 { 
            color: #482a83; 
            margin-bottom: 10px; 
            text-align: center;
            font-size: 1.5rem;
        }

        .editor-container {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .canvas-wrapper {
            position: relative;
            margin: 20px 0;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: grab;
            width: 100%; 
            max-width: 400px; 
            aspect-ratio: 1 / 1;
            height: auto;
            border: 4px solid #fff;
            background-color: #ddd;
            touch-action: none;
        }
        .canvas-wrapper:active { cursor: grabbing; }

        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }

        .controls { width: 100%; display: flex; flex-direction: column; gap: 15px; }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
        }
        
        label { 
            font-weight: 700; 
            font-size: 0.9em; 
            color: #51388E;
            text-transform: uppercase; 
            white-space: nowrap;
        }

        input[type="range"] { 
            flex-grow: 1; 
            margin-left: 15px; 
            cursor: pointer; 
            accent-color: #482a83;
            height: 25px;
        }

        .file-btn {
            display: block;
            width: 100%;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 5px;
            border: 2px dashed #482a83;
            background: white;
            color: #482a83;
            transition: 0.3s;
            position: relative;
            box-sizing: border-box;
        }
        
        .file-btn:active { background: #f0f0f0; }
        .file-btn input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        button#downloadBtn {
            background-color: #482a83;
            color: white;
            border: none;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(72, 42, 131, 0.3);
            -webkit-tap-highlight-color: transparent;
        }
        button#downloadBtn:hover { background-color: #351e60; }
        button#downloadBtn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
    </style>
</head>
<body>

    <h2>Foto de Campa침a</h2>

    <div class="editor-container">
        <div class="controls">
            <div class="file-btn">
                <span>游닝 TOCAR PARA SUBIR FOTO</span>
                <input type="file" id="uploadInput" accept="image/*">
            </div>
        </div>

        <div class="canvas-wrapper">
            <canvas id="mainCanvas" width="770" height="770"></canvas>
        </div>

        <div class="controls">
            <div class="control-row">
                <label>Tama침o Foto</label>
                <input type="range" id="photoScale" min="0.1" max="3" step="0.05" value="1" disabled>
            </div>
            <button id="downloadBtn" disabled>DESCARGAR IMAGEN</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const uploadInput = document.getElementById('uploadInput');
        const photoScaleSlider = document.getElementById('photoScale');
        const downloadBtn = document.getElementById('downloadBtn');

        // === CONFIGURACI칍N AJUSTADA ===
        const config = {
            mainColor: "#482a83", 
            accentColor: "#f7931e", 
            textColor: "#FFFFFF",
            topText: "YO ME UNO",
            bottomTextPart1: "A LA",
            bottomTextPart2: " NUEVA MAYOR칈A",
            
            // Tama침o calculado: (Radio 340 + mitad de borde 45) * 2 = 770
            canvasSize: 770,
            pathRadius: 340,  
            strokeWidth: 90,  
            fontSize: 60      
        };

        let userImage = null;
        let frameImage = new Image();
        let stickerImage = new Image();
        let photoState = { x: 0, y: 0, scale: 1 };
        
        stickerImage.src = "s.png"; 
        
        let stickerState = { 
            x: config.canvasSize / 2, 
            y: config.canvasSize - 230, // Ajustado levemente por el nuevo tama침o
            scale: 1.7, 
            width: 0,
            height: 0
        };

        let isDraggingPhoto = false;
        let startDragX, startDragY;

        function createSVGFrame() {
            const size = config.canvasSize;
            const cx = size / 2;
            const cy = size / 2;
            const r = config.pathRadius;

            const svgString = `
            <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                <defs>
                    <path id="topCurve" d="M ${cx-r},${cy} A ${r},${r} 0 1,1 ${cx+r},${cy}" />
                    <path id="bottomCurve" d="M ${cx-r},${cy} A ${r},${r} 0 0,0 ${cx+r},${cy}" />
                </defs>
                <circle cx="${cx}" cy="${cy}" r="${r}" stroke="${config.mainColor}" stroke-width="${config.strokeWidth}" fill="none" />
                <text fill="${config.textColor}" font-family="Arial Black, Arial, sans-serif" font-weight="900" font-size="${config.fontSize}" dy="5">
                    <textPath href="#topCurve" startOffset="50%" text-anchor="middle" dominant-baseline="middle">
                        ${config.topText}
                    </textPath>
                </text>
                <text font-family="Arial Black, Arial, sans-serif" font-weight="900" font-size="${config.fontSize}" dy="5">
                    <textPath href="#bottomCurve" startOffset="50%" text-anchor="middle" dominant-baseline="middle">
                        <tspan fill="${config.textColor}">${config.bottomTextPart1}</tspan><tspan fill="${config.accentColor}">${config.bottomTextPart2}</tspan>
                    </textPath>
                </text>
            </svg>`;
            
            const blob = new Blob([svgString], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            frameImage.src = url;
            frameImage.onload = () => draw();
        }

        uploadInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    userImage = new Image();
                    userImage.onload = () => {
                        photoState = { x: 0, y: 0, scale: 1 };
                        photoScaleSlider.value = 1;
                        photoScaleSlider.disabled = false;
                        downloadBtn.disabled = false;
                        draw();
                    };
                    userImage.src = event.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        stickerImage.onload = () => draw();

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Aplicamos un recorte circular global para que la descarga sea redonda
            ctx.save();
            ctx.beginPath();
            ctx.arc(canvas.width/2, canvas.height/2, canvas.width/2, 0, Math.PI * 2);
            ctx.clip();

            // 1. DIBUJAR FOTO USUARIO
            if (userImage) {
                ctx.save();
                ctx.beginPath();
                const innerR = config.pathRadius - (config.strokeWidth / 2) + 2; 
                ctx.arc(config.canvasSize/2, config.canvasSize/2, innerR, 0, Math.PI * 2);
                ctx.clip();

                const imgW = userImage.width * photoState.scale;
                const imgH = userImage.height * photoState.scale;
                const x = (canvas.width - imgW) / 2 + photoState.x;
                const y = (canvas.height - imgH) / 2 + photoState.y;

                ctx.drawImage(userImage, x, y, imgW, imgH);
                ctx.restore();
            } else {
                ctx.fillStyle = "#eee";
                ctx.beginPath();
                ctx.arc(canvas.width/2, canvas.height/2, 240, 0, Math.PI * 2);
                ctx.fill();
            }

            // 2. DIBUJAR MARCO (SVG)
            if (frameImage.complete) {
                ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);
            }

            // 3. DIBUJAR STICKER
            if (stickerImage.complete && stickerImage.width > 0) {
                const sW = stickerImage.width;
                const sH = stickerImage.height;
                const aspect = sW / sH;
                const baseSize = 220 * stickerState.scale;
                stickerState.width = baseSize;
                stickerState.height = baseSize / aspect;

                ctx.shadowColor = "#482a83"; // Color morado de la campa침a
                ctx.shadowBlur = 50;         // Cantidad de difuminado
                ctx.shadowOffsetX = 0;       // Desplazamiento horizontal
                ctx.shadowOffsetY = 5;       // Desplazamiento vertical (sombra caida)

                ctx.drawImage(stickerImage, 
                    stickerState.x - (stickerState.width/2), 
                    stickerState.y - (stickerState.height/2), 
                    stickerState.width, 
                    stickerState.height
                );
            }
            ctx.restore(); // Finaliza el recorte circular global
        }

        photoScaleSlider.addEventListener('input', (e) => {
            photoState.scale = parseFloat(e.target.value);
            draw();
        });

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
        }

        function startDrag(e) {
            const pos = getPos(e);
            if (userImage) {
                isDraggingPhoto = true;
                startDragX = pos.x - photoState.x;
                startDragY = pos.y - photoState.y;
            }
        }

        function dragging(e) {
            if (!isDraggingPhoto) return;
            e.preventDefault();
            const pos = getPos(e);
            photoState.x = pos.x - startDragX;
            photoState.y = pos.y - startDragY;
            draw();
        }

        function endDrag() { isDraggingPhoto = false; }

        canvas.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', dragging);
        window.addEventListener('mouseup', endDrag);
        canvas.addEventListener('touchstart', startDrag, {passive: false});
        window.addEventListener('touchmove', dragging, {passive: false});
        window.addEventListener('touchend', endDrag);

        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'mi_foto_campa침a.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        createSVGFrame();
    </script>
</body>
</html>